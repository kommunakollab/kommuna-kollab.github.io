<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Find a Space | Kommuna Kollab</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Poppins", sans-serif; background: url("assets/img/2.jpg") center/cover fixed no-repeat; color: #fff; }
    .muted { color: #cbd5e1; }
    /* small popup wrapper reused */
    .popup-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:60; align-items:center; justify-content:center; }
    .popup-bg.show { display:flex; }
    .card { background: rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.06); border-radius:12px; }
  </style>
</head>
<body class="text-white">

<!-- NAV -->
  <div id="authArea" class="flex items-center gap-3">
  <button id="btnLogin" class="px-3 py-1 border rounded bg-white/6">Login</button>
  <div id="userInfo" class="hidden items-center gap-2">
    <img id="userAvatar" src="" class="w-8 h-8 rounded-full object-cover" alt="avatar">
    <span id="userName" class="text-sm"></span>
    <button id="btnSignOut" class="ml-2 px-2 py-1 border rounded">Sign out</button>
  </div>
</div>
  
<div class="fixed top-0 left-0 w-full bg-black/70 px-6 py-3 flex items-center z-50">
  <div class="flex items-center gap-4">
    <a href="index.html" class="font-semibold">Find a Space</a>
    <span id="navStars" class="text-yellow-300 font-semibold">Stars: 0</span>
  </div>
  <div class="ml-auto">
    <a href="index.html" class="px-3 py-1 border rounded hover:bg-white hover:text-black transition">Back</a>
  </div>
</div>

<main class="pt-20 pb-16 px-6 md:px-20">

  <h1 class="text-4xl md:text-5xl font-semibold mb-10 text-center">Book a Studio in Manila</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

    <!-- MAP -->
    <div class="card p-4 rounded-2xl border border-white/10">
      <h2 class="text-2xl font-semibold mb-3">Studio Map</h2>
      <div class="w-full h-[420px] rounded-xl overflow-hidden bg-white/5 flex items-center justify-center">
        <img src="assets/img/map1.png" alt="Studio Map" class="w-full h-full object-cover opacity-70">
      </div>
    </div>

    <!-- DETAILS -->
    <div id="studioDetails" class="card p-6 rounded-2xl border border-white/10">
      <h2 class="text-2xl font-semibold mb-4">Select a Studio</h2>

      <!-- studio selection -->
      <div class="space-y-3 mb-6">
        <button onclick="selectStudio('Sampaloc Creative Hub')" class="w-full bg-red-500/20 hover:bg-red-500/40 p-3 rounded">Sampaloc Creative Hub</button>
        <button onclick="selectStudio('EspaÃ±a Art Studio')" class="w-full bg-blue-500/20 hover:bg-blue-500/40 p-3 rounded">EspaÃ±a Art Studio</button>
        <button onclick="selectStudio('Recto Film Loft')" class="w-full bg-purple-500/20 hover:bg-purple-500/40 p-3 rounded">Recto Film Loft</button>
        <button onclick="selectStudio('Taft Production Bay')" class="w-full bg-yellow-500/20 hover:bg-yellow-500/40 p-3 rounded">Taft Production Bay</button>
      </div>

      <p class="text-gray-300">Choose a studio above to see details, then pick date & time to book.</p>
    </div>

  </div>
</main>

<!-- PAYMENT POPUP -->
<div id="paymentPopup" class="popup-bg">
  <div class="bg-black/70 w-[420px] p-6 rounded-xl border border-white/10">
    <h3 class="text-xl font-semibold text-center mb-3">Select Payment Method</h3>

    <div class="space-y-3">
      <button class="paymentOption w-full p-3 bg-white/6 rounded text-left" data-method="gcash">ðŸ’™ GCash</button>
      <button class="paymentOption w-full p-3 bg-white/6 rounded text-left" data-method="paymaya">ðŸŸ£ PayMaya</button>
      <button class="paymentOption w-full p-3 bg-white/6 rounded text-left" data-method="card">ðŸ’³ Card</button>
    </div>

    <div id="gcashForm" class="hidden mt-4">
      <label class="muted text-sm">Enter GCash Number</label>
      <input id="gcashNumber" class="w-full mt-2 p-3 rounded bg-white/10 text-black" maxlength="11" placeholder="09XXXXXXXXX">
    </div>

    <div id="paymayaForm" class="hidden mt-4">
      <label class="muted text-sm">Enter PayMaya Number</label>
      <input id="paymayaNumber" class="w-full mt-2 p-3 rounded bg-white/10 text-black" maxlength="11" placeholder="09XXXXXXXXX">
    </div>

    <div id="cardForm" class="hidden mt-4">
      <label class="muted text-sm">Card Number</label>
      <input id="cardNumber" class="w-full mt-2 p-3 rounded bg-white/10 text-black" maxlength="16" placeholder="1234123412341234">
      <div class="flex gap-2 mt-2">
        <input id="cardExp" placeholder="MM/YY" class="w-1/2 p-2 rounded bg-white/10 text-black">
        <input id="cardCVV" placeholder="CVV" class="w-1/2 p-2 rounded bg-white/10 text-black" maxlength="3">
      </div>
    </div>

    <button id="finalPayBtn" disabled class="mt-4 w-full bg-gray-600 opacity-40 p-3 rounded">Confirm Payment</button>
    <button id="closePayment" class="mt-3 w-full bg-white/10 p-3 rounded">Cancel</button>
  </div>
</div>

<!-- CONFIRM POPUP -->
<div id="confirmPopup" class="popup-bg">
  <div class="bg-black/70 w-[360px] p-6 rounded-xl border border-white/10 text-center">
    <h3 class="text-lg font-semibold mb-2">Confirm Booking</h3>
    <p id="confirmText" class="muted mb-4"></p>
    <button id="confirmYes" class="w-full bg-orange-600 p-2 rounded mb-2">Yes, Confirm</button>
    <button id="confirmNo" class="w-full bg-white/10 p-2 rounded">Cancel</button>
  </div>
</div>

<!-- PROCESSING CARD (right panel mimic) -->
<div id="processingPanel" class="hidden fixed right-10 top-28 w-[560px] h-[420px] card p-6 rounded-2xl border border-white/10 z-40 flex items-center justify-center">
  <div class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-white mx-auto mb-4"></div>
    <div class="muted">Processing your booking...</div>
  </div>
</div>

<script type="module">
import { auth, db, loginWithGoogle, loginWithGithub, signOut } from "./assets/js/firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Elements (adjust IDs to match your markup) */
const btnLogin = document.getElementById("btnLogin");
const userInfo = document.getElementById("userInfo");
const userAvatar = document.getElementById("userAvatar");
const userName = document.getElementById("userName");
const btnSignOut = document.getElementById("btnSignOut");
const navStars = document.getElementById("navStars");

/* Local star helpers (same keys we used earlier) */
function getLocalStars(){ return Number(localStorage.getItem("kk_stars") || 0); }
function setLocalStars(n){ localStorage.setItem("kk_stars", String(n)); }

/* Show login chooser */
btnLogin.addEventListener("click", async ()=> {
  // simple chooser: prompt or custom UI. We'll use simple window.confirm, but you can replace with your own UI.
  const choice = confirm("Press OK to login with Google. Press Cancel to login with GitHub.");
  try {
    if (choice) {
      await loginWithGoogle();
    } else {
      await loginWithGithub();
    }
  } catch(e){
    console.error("Login failed", e);
    alert("Login failed: " + (e.message || e));
  }
});

/* Sign out */
btnSignOut.addEventListener("click", async ()=>{
  await signOut();
});

/* Sync local stars -> Firestore on first login (merge) */
async function syncLocalStarsToFirestore(uid){
  try {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    const localStars = getLocalStars();

    if (!snap.exists()) {
      // if no server doc, create with local stars
      await setDoc(ref, { stars: localStars || 0, freeRentAvailable: false });
    } else {
      // merge: if server has less stars than local, update server
      const serverStars = snap.data().stars || 0;
      if (localStars > serverStars) {
        await updateDoc(ref, { stars: localStars });
      } else if (serverStars > localStars) {
        // optionally update local with server's stored stars
        setLocalStars(serverStars);
      }
    }
  } catch(err){
    console.error("Sync stars error:", err);
  }
}

/* Update nav user UI */
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // display user info
    userAvatar.src = user.photoURL || "/assets/img/default-avatar.png";
    userName.innerText = user.displayName || user.email || "User";
    userInfo.classList.remove("hidden");
    btnLogin.classList.add("hidden");

    // sync local stars to Firestore on login
    await syncLocalStarsToFirestore(user.uid);

    // reflect server/local stars in nav (choose local or server; here we read local after sync)
    navStars.innerText = `Stars: ${getLocalStars()}`;
  } else {
    // not logged-in
    userInfo.classList.add("hidden");
    btnLogin.classList.remove("hidden");
    navStars.innerText = `Stars: ${getLocalStars()}`;
  }
});
</script>


</body>
</html>


