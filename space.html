<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Find a Space | Kommuna Kollab</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Poppins", sans-serif; background: url("assets/img/2.jpg") center/cover fixed no-repeat; color: #fff; }
    .muted { color: #cbd5e1; }
    /* small popup wrapper reused */
    .popup-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:60; align-items:center; justify-content:center; }
    .popup-bg.show { display:flex; }
    .card { background: rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.06); border-radius:12px; }
  </style>
</head>
<body class="text-white">

<!-- NAV -->
  <div id="authArea" class="flex items-center gap-3">
  <button id="btnLogin" class="px-3 py-1 border rounded bg-white/6">Login</button>
  <div id="userInfo" class="hidden items-center gap-2">
    <img id="userAvatar" src="" class="w-8 h-8 rounded-full object-cover" alt="avatar">
    <span id="userName" class="text-sm"></span>
    <button id="btnSignOut" class="ml-2 px-2 py-1 border rounded">Sign out</button>
  </div>
</div>
  
<div class="fixed top-0 left-0 w-full bg-black/70 px-6 py-3 flex items-center z-50">
  <div class="flex items-center gap-4">
    <a href="index.html" class="font-semibold">Find a Space</a>
    <span id="navStars" class="text-yellow-300 font-semibold">Stars: 0</span>
  </div>
  <div class="ml-auto">
    <a href="index.html" class="px-3 py-1 border rounded hover:bg-white hover:text-black transition">Back</a>
  </div>
</div>

<main class="pt-20 pb-16 px-6 md:px-20">

  <h1 class="text-4xl md:text-5xl font-semibold mb-10 text-center">Book a Studio in Manila</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

    <!-- MAP -->
    <div class="card p-4 rounded-2xl border border-white/10">
      <h2 class="text-2xl font-semibold mb-3">Studio Map</h2>
      <div class="w-full h-[420px] rounded-xl overflow-hidden bg-white/5 flex items-center justify-center">
        <img src="assets/img/map1.png" alt="Studio Map" class="w-full h-full object-cover opacity-70">
      </div>
    </div>

    <!-- DETAILS -->
    <div id="studioDetails" class="card p-6 rounded-2xl border border-white/10">
      <h2 class="text-2xl font-semibold mb-4">Select a Studio</h2>

      <!-- studio selection -->
      <div class="space-y-3 mb-6">
        <button onclick="selectStudio('Sampaloc Creative Hub')" class="w-full bg-red-500/20 hover:bg-red-500/40 p-3 rounded">Sampaloc Creative Hub</button>
        <button onclick="selectStudio('Espa√±a Art Studio')" class="w-full bg-blue-500/20 hover:bg-blue-500/40 p-3 rounded">Espa√±a Art Studio</button>
        <button onclick="selectStudio('Recto Film Loft')" class="w-full bg-purple-500/20 hover:bg-purple-500/40 p-3 rounded">Recto Film Loft</button>
        <button onclick="selectStudio('Taft Production Bay')" class="w-full bg-yellow-500/20 hover:bg-yellow-500/40 p-3 rounded">Taft Production Bay</button>
      </div>

      <p class="text-gray-300">Choose a studio above to see details, then pick date & time to book.</p>
    </div>

  </div>
</main>

<!-- PAYMENT POPUP -->
<div id="paymentPopup" class="popup-bg">
  <div class="bg-black/70 w-[420px] p-6 rounded-xl border border-white/10">
    <h3 class="text-xl font-semibold text-center mb-3">Select Payment Method</h3>

    <div class="space-y-3">
      <button class="paymentOption w-full p-3 bg-white/6 rounded text-left" data-method="gcash">üíô GCash</button>
      <button class="paymentOption w-full p-3 bg-white/6 rounded text-left" data-method="paymaya">üü£ PayMaya</button>
      <button class="paymentOption w-full p-3 bg-white/6 rounded text-left" data-method="card">üí≥ Card</button>
    </div>

    <div id="gcashForm" class="hidden mt-4">
      <label class="muted text-sm">Enter GCash Number</label>
      <input id="gcashNumber" class="w-full mt-2 p-3 rounded bg-white/10 text-black" maxlength="11" placeholder="09XXXXXXXXX">
    </div>

    <div id="paymayaForm" class="hidden mt-4">
      <label class="muted text-sm">Enter PayMaya Number</label>
      <input id="paymayaNumber" class="w-full mt-2 p-3 rounded bg-white/10 text-black" maxlength="11" placeholder="09XXXXXXXXX">
    </div>

    <div id="cardForm" class="hidden mt-4">
      <label class="muted text-sm">Card Number</label>
      <input id="cardNumber" class="w-full mt-2 p-3 rounded bg-white/10 text-black" maxlength="16" placeholder="1234123412341234">
      <div class="flex gap-2 mt-2">
        <input id="cardExp" placeholder="MM/YY" class="w-1/2 p-2 rounded bg-white/10 text-black">
        <input id="cardCVV" placeholder="CVV" class="w-1/2 p-2 rounded bg-white/10 text-black" maxlength="3">
      </div>
    </div>

    <button id="finalPayBtn" disabled class="mt-4 w-full bg-gray-600 opacity-40 p-3 rounded">Confirm Payment</button>
    <button id="closePayment" class="mt-3 w-full bg-white/10 p-3 rounded">Cancel</button>
  </div>
</div>

<!-- CONFIRM POPUP -->
<div id="confirmPopup" class="popup-bg">
  <div class="bg-black/70 w-[360px] p-6 rounded-xl border border-white/10 text-center">
    <h3 class="text-lg font-semibold mb-2">Confirm Booking</h3>
    <p id="confirmText" class="muted mb-4"></p>
    <button id="confirmYes" class="w-full bg-orange-600 p-2 rounded mb-2">Yes, Confirm</button>
    <button id="confirmNo" class="w-full bg-white/10 p-2 rounded">Cancel</button>
  </div>
</div>

<!-- PROCESSING CARD (right panel mimic) -->
<div id="processingPanel" class="hidden fixed right-10 top-28 w-[560px] h-[420px] card p-6 rounded-2xl border border-white/10 z-40 flex items-center justify-center">
  <div class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-white mx-auto mb-4"></div>
    <div class="muted">Processing your booking...</div>
  </div>
</div>

<script>
/*
  space.html
  - Payment popup (GCash/PayMaya/Card)
  - Local star system (localStorage)
  - FREE booking unlocked at 5 stars (next booking free), resets to 0 after free used
  - No stuck loading
*/

// ---------- Sample studios ----------
const studios = {
  "Sampaloc Creative Hub": {
    price: 150, fee: 50, features: ["Lighting Setup","Backdrops","Small Photo Studio"],
    availability: "10AM - 8PM", location: "Sampaloc, Manila"
  },
  "Espa√±a Art Studio": {
    price: 120, fee: 50, features: ["White Wall","Natural Lighting","Basic Gear"],
    availability: "9AM - 9PM", location: "Espa√±a Blvd"
  },
  "Recto Film Loft": {
    price: 180, fee: 50, features:["Film Lights","Props","Rooftop View"],
    availability: "11AM - 10PM", location: "Recto, Manila"
  },
  "Taft Production Bay": {
    price: 200, fee: 50, features:["Video Lighting","Audio Booth","Large Area"],
    availability: "Open 24 Hours", location: "Taft Ave"
  }
};

// ---------- Helpers: star system (local) ----------
function getLocalStars(){ return Number(localStorage.getItem("kk_stars") || 0); }
function setLocalStars(n){ localStorage.setItem("kk_stars", String(n)); }
function getLocalFree(){ return localStorage.getItem("kk_free") === "1"; }
function setLocalFree(v){ localStorage.setItem("kk_free", v ? "1" : "0"); }

function updateNavStars(){
  document.getElementById("navStars").innerText = `Stars: ${getLocalStars()}`;
}

function updateStudioStarsUI(panel){
  // panel: element that may show star progress (we use nav only here)
  // if you later add progress inside studioDetails, update here
  updateNavStars();
}

// ---------- UI: select studio ----------
function selectStudio(name){
  const d = studios[name];
  const panel = document.getElementById("studioDetails");
  panel.innerHTML = `
    <h2 class="text-3xl font-semibold mb-2">${name}</h2>
    <p class="muted mb-1"><strong>Location:</strong> ${d.location}</p>
    <p class="muted mb-1"><strong>Studio Price:</strong> ‚Ç±${d.price} / hour</p>
    <p class="muted mb-1"><strong>Kommuna Kollab Fee:</strong> ‚Ç±${d.fee}</p>
    <p class="text-yellow-300 text-xl font-semibold mb-3">Total: ‚Ç±${d.price + d.fee} / hour</p>
    <p class="muted mb-3"><strong>Availability:</strong> ${d.availability}</p>
    <p class="muted mb-2">Features:</p>
    <ul class="list-disc pl-6 text-gray-200 mb-4">${d.features.map(f=>`<li>${f}</li>`).join('')}</ul>

    <label class="muted block mb-2">Choose a date:</label>
    <input id="datePick" type="date" class="w-full mb-3 bg-white/10 p-3 rounded text-black">

    <label class="muted block mb-2">Choose a time:</label>
    <input id="timePick" type="time" class="w-full mb-4 bg-white/10 p-3 rounded text-black">

    <div class="flex gap-2">
      <button onclick="bookNow('${name}')" class="w-full bg-orange-500 hover:bg-orange-600 text-black font-semibold py-3 rounded-lg">Book Now</button>
    </div>
  `;
}

// ---------- Booking workflow ----------
let pendingBooking = null; // store selected booking details until payment confirmed

function bookNow(studioName){
  const date = document.getElementById("datePick")?.value;
  const time = document.getElementById("timePick")?.value;

  if(!date || !time){
    alert("Please select a date and time.");
    return;
  }

  const d = studios[studioName];
  pendingBooking = { studioName, date, time, price: d.price, fee: d.fee, total: d.price + d.fee };

  // If user has free booking unlocked, use it immediately and skip payment
  if(getLocalFree()){
    // show processing, then success, consume free and reset stars to 0
    showProcessingPanel();
    setTimeout(()=>{
      hideProcessingPanel();
      alert("üéâ Free booking used! Enjoy your session.");
      setLocalFree(false);
      setLocalStars(0); // reset after free used
      updateStudioStarsUI();
      // show confirmation details
      showBookingConfirmation(pendingBooking, true);
      pendingBooking = null;
    }, 900);
    return;
  }

  // otherwise open payment popup
  openPaymentPopupForPending();
}

function showBookingConfirmation(booking, wasFree=false){
  // Show a friendly confirmation inside studioDetails area
  const panel = document.getElementById("studioDetails");
  panel.innerHTML = `
    <div class="text-center p-6">
      <h2 class="text-3xl font-semibold mb-4">üéâ Booking Confirmed!</h2>
      <p class="muted mb-2"><strong>${booking.studioName}</strong></p>
      <p class="muted mb-3"><strong>Date:</strong> ${booking.date} <br> <strong>Time:</strong> ${booking.time}</p>
      <div class="bg-white/10 border border-white/20 p-4 rounded-xl mb-4">
        <p class="muted"><strong>Studio Price:</strong> ‚Ç±${booking.price}</p>
        <p class="muted"><strong>Kommuna Kollab Fee:</strong> ‚Ç±${booking.fee}</p>
        <p class="text-yellow-300 mt-2 text-xl font-semibold">Total: ‚Ç±${booking.total}</p>
      </div>
      <p class="text-green-400 font-semibold">${wasFree ? "‚≠ê This booking was FREE (from your 5-star reward)!" : "‚≠ê You earned +1 star!"}</p>
      <button onclick="location.reload()" class="mt-4 bg-white text-black px-6 py-3 rounded-lg hover:bg-gray-200">OK</button>
    </div>
  `;
}

// ---------- Processing UI ----------
function showProcessingPanel(){ document.getElementById("processingPanel").classList.remove("hidden"); }
function hideProcessingPanel(){ document.getElementById("processingPanel").classList.add("hidden"); }

// ---------- Payment popup logic ----------
const paymentPopup = document.getElementById("paymentPopup");
const confirmPopup = document.getElementById("confirmPopup");
const processingPanel = document.getElementById("processingPanel");

function openPaymentPopupForPending(){
  // reset forms
  document.getElementById("gcashNumber").value = "";
  document.getElementById("paymayaNumber").value = "";
  document.getElementById("cardNumber").value = "";
  document.getElementById("cardExp").value = "";
  document.getElementById("cardCVV").value = "";
  selectedMethod = null;
  hideAllPaymentForms();
  disableFinalPay();

  // set confirm text for popup
  document.getElementById("confirmText").innerText = `Pay ‚Ç±${pendingBooking.total} for ${pendingBooking.studioName}?`;

  paymentPopup.classList.add("show");
}

document.getElementById("closePayment").onclick = ()=> paymentPopup.classList.remove("show");
document.getElementById("confirmNo").onclick = ()=> confirmPopup.classList.remove("show");

// payment option buttons
let selectedMethod = null;
document.querySelectorAll(".paymentOption").forEach(btn=>{
  btn.addEventListener("click", (e)=>{
    selectedMethod = btn.dataset.method;
    hideAllPaymentForms();
    if(selectedMethod==="gcash") document.getElementById("gcashForm").classList.remove("hidden");
    if(selectedMethod==="paymaya") document.getElementById("paymayaForm").classList.remove("hidden");
    if(selectedMethod==="card") document.getElementById("cardForm").classList.remove("hidden");
    validatePaymentInputs();
  });
});

function hideAllPaymentForms(){
  document.getElementById("gcashForm").classList.add("hidden");
  document.getElementById("paymayaForm").classList.add("hidden");
  document.getElementById("cardForm").classList.add("hidden");
}
function disableFinalPay(){ const b=document.getElementById("finalPayBtn"); b.disabled=true; b.classList.add("opacity-40"); }
function enableFinalPay(){ const b=document.getElementById("finalPayBtn"); b.disabled=false; b.classList.remove("opacity-40"); }

function validatePaymentInputs(){
  if(!selectedMethod) return disableFinalPay();

  if(selectedMethod==="gcash"){
    if(document.getElementById("gcashNumber").value.trim().length===11) enableFinalPay(); else disableFinalPay();
  } else if(selectedMethod==="paymaya"){
    if(document.getElementById("paymayaNumber").value.trim().length===11) enableFinalPay(); else disableFinalPay();
  } else if(selectedMethod==="card"){
    const num=document.getElementById("cardNumber").value.trim();
    const cvv=document.getElementById("cardCVV").value.trim();
    if(num.length===16 && cvv.length===3) enableFinalPay(); else disableFinalPay();
  }
}

["gcashNumber","paymayaNumber","cardNumber","cardCVV","cardExp"].forEach(id=>{
  const el=document.getElementById(id); if(el) el.addEventListener("input", validatePaymentInputs);
});

// finalPayBtn opens confirm popup (we already filled confirmText)
document.getElementById("finalPayBtn").onclick = ()=>{
  paymentPopup.classList.remove("show");
  confirmPopup.classList.add("show");
};

// confirmYes performs the simulated payment, adds star, shows confirmation
document.getElementById("confirmYes").onclick = async ()=>{
  confirmPopup.classList.remove("show");
  showProcessingPanel();

  // simulate payment processing delay
  setTimeout(()=>{
    hideProcessingPanel();

    // simulate saving payment record (you can integrate Firestore here)
    // add star logic
    let stars = getLocalStars();
    stars++;
    if(stars >= 5){
      // reach 5: unlock free booking for next time and keep stars at 5 for display
      setLocalFree(true);
      alert("üéâ You reached 5 stars! Your NEXT booking will be FREE.");
      // keep stars at 5 (we show 5 until free is used)
      setLocalStars(5);
    } else {
      setLocalStars(stars);
      alert("Payment successful! You earned +1 star.");
    }

    // update nav UI & show booking confirmation
    updateStudioStarsUI();

    // display booking confirmation and consume/clear pendingBooking
    showBookingConfirmation(pendingBooking, false);
    pendingBooking = null;

  }, 900);
};

// init nav stars on page load
updateNavStars();

</script>

</body>
</html>

