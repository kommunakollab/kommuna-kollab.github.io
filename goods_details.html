<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rent the Goods | Kommuna Kollab</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: "Poppins", sans-serif;
    background: none !important;
    color: white;
  }
  body::before {
    content: "";
    background: url("assets/img/2.jpg") center/cover fixed no-repeat;
    position: fixed;
    inset: 0;
    z-index: -1;
    opacity: 0.96;
  }
  .popup-bg {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(3px);
    z-index: 60;
    justify-content: center;
    align-items: center;
  }
  .popup-bg.show { display: flex; }
</style>
</head>

<body class="text-white">

<!-- NAV -->
<div class="fixed top-0 left-0 w-full bg-black/70 px-6 py-4 flex justify-between items-center z-50 shadow">
  <h1 class="text-lg font-semibold">Rent the Goods</h1>
  <a href="goods.html" class="px-3 py-1 border rounded hover:bg-white hover:text-black transition">Back</a>
</div>

<section class="pt-24 pb-16 px-6">
  <div class="max-w-3xl mx-auto bg-black/50 p-8 rounded-2xl border border-white/10">

    <h1 id="goodTitle" class="text-center text-3xl font-semibold mb-6">Loading...</h1>

    <p class="mb-2"><strong>Model:</strong> <span id="goodModel"></span></p>
    <p class="mb-4"><strong>Description:</strong> <span id="goodDescription"></span></p>
    <p class="mb-4"><strong>Year:</strong> <span id="goodYear"></span></p>

    <p class="text-xl text-yellow-400 font-bold">‚Ç±<span id="goodPrice">0</span> per day</p>

    <div class="flex items-center gap-2 mt-2">
  <span class="text-gray-300">Stars:</span>
  <div id="starRating" class="flex text-yellow-400 text-2xl select-none">
    ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
  </div>
  <span id="starCount" class="text-gray-300 ml-2">(0/5)</span>
</div>



    <div id="starProgress" class="mt-2 text-center text-yellow-300"></div>

    <button id="openRent"
      class="mt-6 w-full bg-orange-600 hover:bg-orange-700 text-black py-3 rounded-lg font-semibold">
      RENT THE GOODS
    </button>
  </div>
</section>

<!-- PAYMENT POPUP -->
<div id="paymentPopup" class="popup-bg">
  <div class="bg-black/60 p-6 rounded-xl w-96 border border-white/10">
    <h2 class="text-xl font-bold text-center mb-4">Select Payment Method</h2>

    <div class="space-y-3">
      <button class="paymentOption w-full p-3 bg-white/10 rounded" data-method="gcash">üíô GCash</button>
      <button class="paymentOption w-full p-3 bg-white/10 rounded" data-method="paymaya">üü£ PayMaya</button>
      <button class="paymentOption w-full p-3 bg-white/10 rounded" data-method="card">üí≥ Card</button>
    </div>

    <!-- Forms -->
    <div id="gcashForm" class="hidden mt-4">
      <label>GCash Number</label>
      <input id="gcashNumber" class="w-full mt-1 p-2 rounded bg-white/20" maxlength="11">
    </div>

    <div id="paymayaForm" class="hidden mt-4">
      <label>PayMaya Number</label>
      <input id="paymayaNumber" class="w-full mt-1 p-2 rounded bg-white/20" maxlength="11">
    </div>

    <div id="cardForm" class="hidden mt-4">
      <label>Card Number</label>
      <input id="cardNumber" class="w-full p-2 rounded bg-white/20" maxlength="16">
      <div class="flex gap-2 mt-2">
        <input id="cardExp" placeholder="MM/YY" class="w-1/2 p-2 rounded bg-white/20">
        <input id="cardCVV" placeholder="CVV" maxlength="3" class="w-1/2 p-2 rounded bg-white/20">
      </div>
    </div>

    <button id="finalPayBtn"
      class="w-full mt-4 bg-gray-600 opacity-40 text-black p-2 rounded" disabled>
      Confirm Payment
    </button>

    <button id="closePayment" class="mt-3 w-full bg-red-600 p-2 rounded">Cancel</button>
  </div>
</div>

<!-- CONFIRM POPUP -->
<div id="confirmPopup" class="popup-bg">
  <div class="bg-black/60 p-6 rounded-xl border border-white/10 w-80 text-center">
    <h2 class="text-xl font-bold mb-3">Confirm Payment</h2>
    <p id="confirmText" class="text-gray-300 mb-4"></p>

    <button id="confirmYes" class="w-full bg-orange-600 p-2 rounded mb-2">Yes, Pay</button>
    <button id="confirmNo" class="w-full bg-white/20 p-2 rounded">Cancel</button>
  </div>
</div>

<script type="module">
import { auth, db } from "./assets/js/firebase.js";
import {
  doc, getDoc, setDoc, addDoc, collection, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { addStar, loadUserStars } from "./assets/js/star-system.js";  // ‚≠ê REQUIRED

function param(n) {
  const p = new URLSearchParams(location.search).get(n);
  return p ? decodeURIComponent(p) : "";
}

const data = {
  title: param("title"),
  description: param("description"),
  model: param("model"),
  year: param("year"),
  price: Number(param("price"))
};

goodTitle.innerText = data.title;
goodModel.innerText = data.model;
goodDescription.innerText = data.description;
goodYear.innerText = data.year;
goodPrice.innerText = data.price;

let selectedMethod = null;

/* PAYMENT POPUP */
openRent.onclick = () => paymentPopup.classList.add("show");
closePayment.onclick = () => paymentPopup.classList.remove("show");
confirmNo.onclick = () => confirmPopup.classList.remove("show");

document.querySelectorAll(".paymentOption").forEach(btn => {
  btn.onclick = () => {
    selectedMethod = btn.dataset.method;

    gcashForm.classList.add("hidden");
    paymayaForm.classList.add("hidden");
    cardForm.classList.add("hidden");

    if (selectedMethod === "gcash") gcashForm.classList.remove("hidden");
    if (selectedMethod === "paymaya") paymayaForm.classList.remove("hidden");
    if (selectedMethod === "card") cardForm.classList.remove("hidden");

    validatePay();
  };
});

function validatePay() {
  if (selectedMethod === "gcash" && gcashNumber.value.length === 11)
    return enablePay();
  if (selectedMethod === "paymaya" && paymayaNumber.value.length === 11)
    return enablePay();
  if (selectedMethod === "card" && cardNumber.value.length === 16 && cardCVV.value.length === 3)
    return enablePay();

  disablePay();
}

function enablePay() {
  finalPayBtn.disabled = false;
  finalPayBtn.classList.remove("opacity-40");
}
function disablePay() {
  finalPayBtn.disabled = true;
  finalPayBtn.classList.add("opacity-40");
}

["gcashNumber","paymayaNumber","cardNumber","cardCVV","cardExp"].forEach(id=>{
  let el=document.getElementById(id);
  if(el) el.oninput=validatePay;
});

/* PAYMENT CONFIRM */
finalPayBtn.onclick = () => {
  confirmText.innerText = `Pay ‚Ç±${data.price} for ${data.title}?`;
  confirmPopup.classList.add("show");
};

confirmYes.onclick = async () => {
  confirmPopup.classList.remove("show");
  paymentPopup.classList.remove("show");

  const u = auth.currentUser;
  if (!u) return alert("Please login first.");

  await addDoc(collection(db,"payments"), {
    userId: u.uid,
    title: data.title,
    method: selectedMethod,
    amount: data.price,
    createdAt: serverTimestamp()
  });

  await addStar(u.uid);
  await loadUserStars(u.uid, userStarsDisplay, starProgress);

  alert("Payment successful! +1 ‚≠ê");

  setTimeout(() => {
    window.location.href = "goods.html";
  }, 1000);
};

onAuthStateChanged(auth, (u)=>{
  if (u) loadUserStars(u.uid, userStarsDisplay, starProgress);
});

// ‚≠ê NEW LOCAL STAR SYSTEM (NO FIREBASE)
// ‚≠ê SIMPLE STAR SYSTEM WITH FREE RENT
function getStars() {
  return Number(localStorage.getItem("userStars") || 0);
}

function saveStars(n) {
  localStorage.setItem("userStars", n);
}

function updateStarsUI() {
  let stars = getStars();
  let starEl = document.getElementById("starRating");
  let countEl = document.getElementById("starCount");

  let display = "";
  for (let i = 0; i < 5; i++) {
    display += i < stars ? "‚òÖ" : "‚òÜ";
  }

  starEl.innerHTML = display;
  countEl.innerText = `(${stars}/5)`;
}

// ‚≠ê Add star each time they click RENT
function earnStar() {
  let stars = getStars();
  stars++;

  // ‚≠ê FREE RENT TRIGGER
  if (stars >= 5) {
    alert("üéÅ You reached 5 stars! This rent is FREE.");
    stars = 0; // reset after free rent
  }

  saveStars(stars);
  updateStarsUI();
}

// ‚≠ê RENT BUTTON BEHAVIOR
document.getElementById("openRent").addEventListener("click", () => {
  let stars = getStars();

  if (stars === 0) {
    // This means the free rent was just triggered
    alert("üéâ Your rent was FREE! Enjoy!");
    return;
  }

  // ELSE normal payment popup opens
  paymentPopup.classList.add("show");

  earnStar(); // add a star immediately
});

// ‚≠ê Load stars on page load
updateStarsUI();




</script>

</body>
</html>
